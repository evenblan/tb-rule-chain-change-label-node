# Custom ThingsBoard Rule Node: Change Entity Label

This project provides a custom ThingsBoard rule node that allows you to change the label (name/title) of an entity (Device, Asset, or Customer) based on incoming messages.

## Functionality

The "Change Entity Label" rule node can determine the new label from:
*   A static string value.
*   A value from the incoming message's metadata.
*   A value from the incoming message's JSON payload.

The node identifies the entity type (Device, Asset, Customer) from the message originator. If the label update is successful, the message is routed via the "Success" chain; otherwise, it's routed via the "Failure" chain.

## Prerequisites

Ensure you have the following installed:
*   [OpenJDK 17](https://adoptium.net/) (or the Java version targeted by your ThingsBoard instance)
*   [Apache Maven](https://maven.apache.org/download.cgi) (3.6.0+ recommended)
*   [Node.js and npm](https://nodejs.org/) (for compiling the Angular UI component - version compatible with Angular used in your ThingsBoard version)
*   [Angular CLI](https://angular.io/cli) (globally or locally, for compiling the UI component)

## Building the Rule Node

The rule node consists of a Java backend and an Angular frontend component for configuration.

**1. Backend (Java):**

Compile the Java part of the project and package it into a JAR file:
```bash
mvn clean package
```
This command will generate the JAR file in the `target/` directory (e.g., `target/custom-nodes-1.0.0.jar`). This JAR contains the main rule node logic.

**2. Frontend (Angular UI Configuration):**

The UI configuration for this rule node is built using Angular. The source files are:
*   `change-label-node-config.component.ts`
*   `change-label-node-config.html`

These files need to be compiled into a JavaScript file. The `ChangeLabelNode.java` expects this file to be available as `static/rulenode/change-label-node-config.js`.

**Steps to compile and include the UI:**

*   **Option A: Manual Compilation and Placement (Recommended for this repository's structure)**
    1.  You will need to set up a minimal Angular environment if you don't have one, or integrate these components into an existing Angular workspace that can compile them.
    2.  Compile `change-label-node-config.component.ts` (and its HTML template) into a single JavaScript file named `change-label-node-config.js`. This typically involves using the Angular CLI (`ng build`). *Note: This repository does not provide a pre-configured Angular build setup for this individual component.*
    3.  Create the directory `src/main/resources/public/static/rulenode/`.
    4.  Place the compiled `change-label-node-config.js` file into `src/main/resources/public/static/rulenode/`.
    5.  Re-run `mvn clean package`. The `maven-resources-plugin` (default part of Maven builds) should then include this JS file in the final JAR at the correct path (`/static/rulenode/change-label-node-config.js`).

*   **Option B: Deploying JS separately**
    Alternatively, the compiled `change-label-node-config.js` can be deployed directly to the ThingsBoard server's static content directory that serves rule node UI resources, if your ThingsBoard deployment allows for that.

**Why is the UI compilation separate?**
This repository is focused on providing just the rule node code. Integrating a full Angular build process into the `pom.xml` for a single component adds complexity not desired here. The `ChangeLabelNode.java` file references the expected JavaScript file via the `@RuleNode` annotation's `uiResources` attribute.

## Deploying and Using the Node

1.  **Deploy the JAR:**
    *   Take the JAR file generated by `mvn package` (e.g., `target/custom-nodes-1.0.0.jar`).
    *   Deploy this JAR to your ThingsBoard instance. This usually involves placing it in the appropriate extensions or plugins directory for your ThingsBoard installation or microservice. Consult the official ThingsBoard documentation for "Custom Rule Nodes" deployment.

2.  **Package Scanning:**
    Ensure ThingsBoard is configured to scan the package containing your custom rule node. The Java class `ChangeLabelNode` is in package `org.thingsboard.rule.engine.node`. The `pom.xml` uses `org.thingsboard.custom` as the `groupId`. Ensure your `PLUGINS_SCAN_PACKAGES` environment variable (or equivalent configuration in ThingsBoard) includes `org.thingsboard.rule.engine.node` or a parent package like `org.thingsboard.rule.engine` or `org.thingsboard.custom`.

3.  **Add and Configure in ThingsBoard UI:**
    *   After deploying the JAR and restarting ThingsBoard (if necessary), refresh the ThingsBoard web UI.
    *   Navigate to the Rule Chain where you want to add the node.
    *   Click the "+" icon to add a new node. The "Change Entity Label" node should appear in the **Action** section.
    *   Drag and drop it onto your rule chain.
    *   Configure the node:
        *   **Label Source:** `STATIC`, `MESSAGE_METADATA`, or `MESSAGE_DATA`.
        *   **Static Label Value:** If Label Source is `STATIC`.
        *   **Label Name or Pattern:** If Label Source is `MESSAGE_METADATA` or `MESSAGE_DATA`.
        *   **Target Entity Type:** (Optional) The Angular form includes this field. However, the Java node primarily determines the entity type from the message originator (`msg.getOriginator().getEntityType()`) and does not currently use this configuration field in its logic.
    *   Save the configuration and the rule chain.

## Troubleshooting

*   Check the logs of your ThingsBoard server or `tb-rule-engine` service for errors during startup or message processing.
*   Enable debug mode for the "Change Entity Label" node in your rule chain to see how it processes messages.
